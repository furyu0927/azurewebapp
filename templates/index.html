<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chappy🐶</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- 既存のCSSはそのまま --- */
#clearBtn {
    margin-top: 10px;
    padding: 10px 16px;
    background: #d6bfae;
    color: #5a3e36;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}
#clearBtn:hover {
    background: #bfa183;
}
</style>
</head>
<body>
<h1>Chappy🐶</h1>
<div class="chat-container">
    <div class="chat-history" id="chatHistory">
        {% for msg in chat_history %}
            {% if msg.role == "user" %}
                <div class="message user"><strong>🍎:</strong> {{ msg.content }}</div>
            {% else %}
                <div class="message bot"><strong>Chappy🐶:</strong> {{ msg.content }}</div>
            {% endif %}
        {% endfor %}
    </div>
    <div id="typingIndicator">Chappy🐶が入力中…</div>
    <form id="chatForm" class="input-box">
        <input type="text" name="user_input" placeholder="質問を入力してください" required>
        <button type="submit">送信</button>
    </form>
    <!-- 履歴消去ボタン -->
    <button id="clearBtn">履歴を消去</button>
</div>

<button id="scrollBottomBtn" title="下へ移動">🐶</button>

<script>
const chatHistory = document.getElementById("chatHistory");
const scrollBtn = document.getElementById("scrollBottomBtn");
const typingIndicator = document.getElementById("typingIndicator");
const form = document.getElementById("chatForm");
const input = form.querySelector("input");

// スクロールボタン表示
chatHistory.addEventListener("scroll", () => {
    if (chatHistory.scrollTop + chatHistory.clientHeight < chatHistory.scrollHeight - 20) {
        scrollBtn.classList.add("show");
    } else {
        scrollBtn.classList.remove("show");
    }
});
scrollBtn.addEventListener("click", () => {
    chatHistory.scrollTop = chatHistory.scrollHeight;
});

// Ajax送信
form.addEventListener("submit", (e) => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;

    const userDiv = document.createElement("div");
    userDiv.className = "message user";
    userDiv.innerHTML = `<strong>🍎:</strong> ${userText}`;
    chatHistory.appendChild(userDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    input.value = "";

    typingIndicator.style.display = "block";

    fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `user_input=${encodeURIComponent(userText)}`,
        credentials: "same-origin"
    })
    .then(res => res.json())
    .then(data => {
        typingIndicator.style.display = "none";
        const botDiv = document.createElement("div");
        botDiv.className = "message bot";
        botDiv.innerHTML = `<strong>🐶:</strong> ${data.reply}`;
        chatHistory.appendChild(botDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    })
    .catch(err => {
        typingIndicator.style.display = "none";
        alert("通信エラーが発生しました");
    });
});

// 履歴消去
document.getElementById("clearBtn").addEventListener("click", () => {
    fetch("/clear", {
        method: "POST",
        credentials: "same-origin"
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "cleared") {
            chatHistory.innerHTML = "";
        }
    })
    .catch(err => alert("履歴消去に失敗しました"));
});

// ページ読み込み時に最下部へ
window.addEventListener("load", () => {
    chatHistory.scrollTop = chatHistory.scrollHeight;
});
</script>
</body>
</html>
