<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChappyğŸ¶</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- æ—¢å­˜ã®CSSã¯ãã®ã¾ã¾ --- */
#clearBtn {
    margin-top: 10px;
    padding: 10px 16px;
    background: #d6bfae;
    color: #5a3e36;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}
#clearBtn:hover {
    background: #bfa183;
}
</style>
</head>
<body>
<h1>ChappyğŸ¶</h1>
<div class="chat-container">
    <div class="chat-history" id="chatHistory">
        {% for msg in chat_history %}
            {% if msg.role == "user" %}
                <div class="message user"><strong>ğŸ:</strong> {{ msg.content }}</div>
            {% else %}
                <div class="message bot"><strong>ChappyğŸ¶:</strong> {{ msg.content }}</div>
            {% endif %}
        {% endfor %}
    </div>
    <div id="typingIndicator">ChappyğŸ¶ãŒå…¥åŠ›ä¸­â€¦</div>
    <form id="chatForm" class="input-box">
        <input type="text" name="user_input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
        <button type="submit">é€ä¿¡</button>
    </form>
    <!-- å±¥æ­´æ¶ˆå»ãƒœã‚¿ãƒ³ -->
    <button id="clearBtn">å±¥æ­´ã‚’æ¶ˆå»</button>
</div>

<button id="scrollBottomBtn" title="ä¸‹ã¸ç§»å‹•">ğŸ¶</button>

<script>
const chatHistory = document.getElementById("chatHistory");
const scrollBtn = document.getElementById("scrollBottomBtn");
const typingIndicator = document.getElementById("typingIndicator");
const form = document.getElementById("chatForm");
const input = form.querySelector("input");

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³è¡¨ç¤º
chatHistory.addEventListener("scroll", () => {
    if (chatHistory.scrollTop + chatHistory.clientHeight < chatHistory.scrollHeight - 20) {
        scrollBtn.classList.add("show");
    } else {
        scrollBtn.classList.remove("show");
    }
});
scrollBtn.addEventListener("click", () => {
    chatHistory.scrollTop = chatHistory.scrollHeight;
});

// Ajaxé€ä¿¡
form.addEventListener("submit", (e) => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;

    const userDiv = document.createElement("div");
    userDiv.className = "message user";
    userDiv.innerHTML = `<strong>ğŸ:</strong> ${userText}`;
    chatHistory.appendChild(userDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    input.value = "";

    typingIndicator.style.display = "block";

    fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `user_input=${encodeURIComponent(userText)}`,
        credentials: "same-origin"
    })
    .then(res => res.json())
    .then(data => {
        typingIndicator.style.display = "none";
        const botDiv = document.createElement("div");
        botDiv.className = "message bot";
        botDiv.innerHTML = `<strong>ğŸ¶:</strong> ${data.reply}`;
        chatHistory.appendChild(botDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    })
    .catch(err => {
        typingIndicator.style.display = "none";
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    });
});

// å±¥æ­´æ¶ˆå»
document.getElementById("clearBtn").addEventListener("click", () => {
    fetch("/clear", {
        method: "POST",
        credentials: "same-origin"
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "cleared") {
            chatHistory.innerHTML = "";
        }
    })
    .catch(err => alert("å±¥æ­´æ¶ˆå»ã«å¤±æ•—ã—ã¾ã—ãŸ"));
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æœ€ä¸‹éƒ¨ã¸
window.addEventListener("load", () => {
    chatHistory.scrollTop = chatHistory.scrollHeight;
});
</script>
</body>
</html>
